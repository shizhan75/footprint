const MAP_CONFIG = {
  'china': {
    'name': ['中国', 'china'],
    'mapName': 'cn_merc',
    'provinces': {
      'XZ': {
      'name': ['西藏自治区'],
        'displayName': '西藏',
      },
      'GS': {
      'name': ['甘肃省'],
        'displayName': '甘肃'
      },
      'GZ': {
      'name': ['贵州省'],
        'displayName': '贵州'
      },
      'YN': {
      'name': ['云南省'],
        'displayName': '云南'
      },
      'CQ': {
      'name': ['重庆市'],
        'displayName': '重庆'
      },
      'SC': {
      'name': ['四川省'],
        'displayName': '四川'
      },
      'SH': {
      'name': ['上海市'],
        'displayName': '上海'
      },
      'JS': {
      'name': ['江苏省'],
        'displayName': '江苏'
      },
      'ZJ': {
      'name': ['浙江省'],
        'displayName': '浙江'
      },
      'SX': {
      'name': ['山西省'],
        'displayName': '山西'
      },
      'FJ': {
      'name': ['福建省'],
        'displayName': '福建'
      },
      'TJ': {
      'name': ['天津市'],
        'displayName': '天津'
      },
      'HE': {
      'name': ['河北省'],
        'displayName': '河北'
      },
      'BJ': {
      'name': ['北京市'],
        'displayName': '北京'
      },
      'AH': {
      'name': ['安徽省'],
        'displayName': '安徽'
      },
      'JX': {
      'name': ['江西省'],
        'displayName': '江西'
      },
      'SD': {
      'name': ['山东省'],
        'displayName': '山东'
      },
      'HA': {
      'name': ['河南省'],
        'displayName': '河南'
      },
      'HN': {
      'name': ['湖南省'],
        'displayName': '湖南'
      },
      'HB': {
      'name': ['湖北省'],
        'displayName': '湖北'
      },
      'GX': {
      'name': ['广西壮族自治区'],
        'displayName': '广西'
      },
      'GD': {
      'name': ['广东省'],
        'displayName': '广东'
      },
      'HI': {
      'name': ['海南省'],
        'displayName': '海南'
      },
      'XJ': {
      'name': ['新疆维吾尔自治区'],
        'displayName': '新疆'
      },
      'NX': {
      'name': ['宁夏回族自治区'],
        'displayName': '宁夏'
      },
      'QH': {
      'name': ['青海省'],
        'displayName': '青海'
      },
      'NM': {
      'name': ['内蒙古自治区'],
        'displayName': '内蒙古'
      },
      'SN': {
      'name': ['陕西省'],
        'displayName': '陕西'
      },
      'HL': {
      'name': ['黑龙江省'],
        'displayName': '黑龙江'
      },
      'JL': {
      'name': ['吉林省'],
        'displayName': '吉林'
      },
      'LN': {
      'name': ['辽宁省'],
        'displayName': '辽宁'
      },
      'TW': {
      'name': ['台湾省'],
        'displayName': '台湾'
      },
      'XG': {
      'name': ['香港特别行政区'],
        'displayName': '香港'
      },
      'AM': {
      'name': ['澳门特别行政区'],
        'displayName': '澳门'
      },
    },
  },
  'japan': {
    'name': ['日本', 'japan'],
    'mapName': 'jp_merc',
    'provinces': {
      'Shimane': {
        'name': ['島根県'],
        'displayName': '島根県',
        'region': '中国地方'
      },
      'Wakayama': {
        'name': ['和歌山県'],
        'displayName': '和歌山県',
        'region': '近畿地方'
      },
      'Yamanashi': {
        'name': ['山梨県'],
        'displayName': '山梨県',
        'region': '中部地方'
      },
      'Kanagawa': {
        'name': ['神奈川県'],
        'displayName': '神奈川県',
        'region': '关东地方'
      },
      'Kagawa': {
        'name': ['香川県'],
        'displayName': '香川県',
        'region': '四国地方'
      },
      'Shizuoka': {
        'name': ['静岡県'],
        'displayName': '静岡県',
        'region': '中部地方'
      },
      'Ehime': {
        'name': ['愛媛県'],
        'displayName': '愛媛県',
        'region': '四国地方'
      },
      'Mie': {
        'name': ['三重県'],
        'displayName': '三重県',
        'region': '近畿地方'
      },
      'Kumamoto': {
        'name': ['熊本県'],
        'displayName': '熊本県',
        'region': '九州地方'
      },
      'Chiba': {
        'name': ['千葉県'],
        'displayName': '千葉県',
        'region': '关东地方'
      },
      'Aichi': {
        'name': ['愛知県'],
        'displayName': '愛知県',
        'region': '中部地方'
      },
      'Nagasaki': {
        'name': ['長崎県'],
        'displayName': '長崎県',
        'region': '九州地方'
      },
      'Nara': {
        'name': ['奈良県'],
        'displayName': '奈良県',
        'region': '近畿地方'
      },
      'Shiga': {
        'name': ['滋賀県'],
        'displayName': '滋賀県',
        'region': '近畿地方'
      },
      'Miyagi': {
        'name': ['宮城県'],
        'displayName': '宮城県',
        'region': '东北地方'
      },
      'Gunma': {
        'name': ['群馬県'],
        'displayName': '群馬県',
        'region': '关东地方'
      },
      'Kyoto': {
        'name': ['京都府'],
        'displayName': '京都府',
        'region': '近畿地方'
      },
      'Tokyo': {
        'name': ['東京都'],
        'displayName': '東京都',
        'region': '关东地方'
      },
      'Hyogo': {
        'name': ['兵庫県'],
        'displayName': '兵庫県',
        'region': '近畿地方'
      },
      'Okinawa': {
        'name': ['沖縄県'],
        'displayName': '沖縄県',
        'region': '冲绳地方'
      },
      'Iwate': {
        'name': ['岩手県'],
        'displayName': '岩手県',
        'region': '东北地方'
      },
      'Kochi': {
        'name': ['高知県'],
        'displayName': '高知県',
        'region': '四国地方'
      },
      'Yamagata': {
        'name': ['山形県'],
        'displayName': '山形県',
        'region': '东北地方'
      },
      'Ishikawa': {
        'name': ['石川県'],
        'displayName': '石川県',
        'region': '中部地方'
      },
      'Fukuoka': {
        'name': ['福岡県'],
        'displayName': '福岡県',
        'region': '九州地方'
      },
      'Miyazaki': {
        'name': ['宮崎県'],
        'displayName': '宮崎県',
        'region': '九州地方'
      },
      'Aomori': {
        'name': ['青森県'],
        'displayName': '青森県',
        'region': '东北地方'
      },
      'Gifu': {
        'name': ['岐阜県'],
        'displayName': '岐阜県',
        'region': '中部地方'
      },
      'Tochigi': {
        'name': ['栃木県'],
        'displayName': '栃木県',
        'region': '关东地方'
      },
      'Nagano': {
        'name': ['長野県'],
        'displayName': '長野県',
        'region': '中部地方'
      },
      'Toyama': {
        'name': ['富山県'],
        'displayName': '富山県',
        'region': '中部地方'
      },
      'Oita': {
        'name': ['大分県'],
        'displayName': '大分県',
        'region': '九州地方'
      },
      'Hiroshima': {
        'name': ['広島県'],
        'displayName': '広島県',
        'region': '中国地方'
      },
      'Niigata': {
        'name': ['新潟県'],
        'displayName': '新潟県',
        'region': '中部地方'
      },
      'Fukui': {
        'name': ['福井県'],
        'displayName': '福井県',
        'region': '中部地方'
      },
      'Ibaraki': {
        'name': ['茨城県'],
        'displayName': '茨城県',
        'region': '关东地方'
      },
      'Kagoshima': {
        'name': ['鹿児島県'],
        'displayName': '鹿児島県',
        'region': '九州地方'
      },
      'Saitama': {
        'name': ['埼玉県'],
        'displayName': '埼玉県',
        'region': '关东地方'
      },
      'Saga': {
        'name': ['佐賀県'],
        'displayName': '佐賀県',
        'region': '九州地方'
      },
      'Tokushima': {
        'name': ['徳島県'],
        'displayName': '徳島県',
        'region': '四国地方'
      },
      'Osaka': {
        'name': ['大阪府'],
        'displayName': '大阪府',
        'region': '近畿地方'
      },
      'Okayama': {
        'name': ['岡山県'],
        'displayName': '岡山県',
        'region': '中国地方'
      },
      'Akita': {
        'name': ['秋田県'],
        'displayName': '秋田県',
        'region': '东北地方'
      },
      'Fukushima': {
        'name': ['福島県'],
        'displayName': '福島県',
        'region': '东北地方'
      },
      'Yamaguchi': {
        'name': ['山口県'],
        'displayName': '山口県',
        'region': '中国地方'
      },
      'Hokkaido': {
        'name': ['北海道'],
        'displayName': '北海道',
        'region': '北海道地方'
      },
      'Tottori': {
        'name': ['鳥取県'],
        'displayName': '鳥取県',
        'region': '中国地方'
      }
    },
    'onload': (map) => {
      map.setScale(1.4218945379406982, 640, 349, false, false);
      map.transX = 0.10370524870243536;
      map.transY = -44.24692109307475;
      map.applyTransform();
    },
  }
};

function assertCountryId(countryId) {
  if (MAP_CONFIG[countryId] == null) {
    throw Error(`do not have country ${countryId}`);
  }
}

class FootprintData {
  constructor(footprints) {
    this.footprints = footprints;

    this.mapCountryName = {};
    this.mapProvinceName = {};
    this.mapCountryFootprint = {};
    this.mapProvinceFootprint = {};
    for (let countryId in MAP_CONFIG) {
      let countryInfo = MAP_CONFIG[countryId];
      for (let name of countryInfo.name) {
        this.mapCountryName[name] = countryId;
      }
      this.mapCountryFootprint[countryId] = [];
      this.mapProvinceName[countryId] = {};
      this.mapProvinceFootprint[countryId] = {};
      for (let provinceId in countryInfo.provinces) {
        let provinceInfo = countryInfo.provinces[provinceId];
        for (let name of provinceInfo.name) {
          this.mapProvinceName[countryId][name] = provinceId;
          this.mapProvinceFootprint[countryId][provinceId] = [];
        }
      }
    }

    for (let footprint of this.footprints) {
      let {countryId, provinceId} = this.parseProvince(footprint);
      if (this.mapCountryFootprint[countryId] != null) {
        footprint._index = this.mapCountryFootprint[countryId].length;
        this.mapCountryFootprint[countryId].push(footprint);
      }
      if (this.mapProvinceFootprint[countryId] != null && this.mapProvinceFootprint[countryId][provinceId] != null) {
        this.mapProvinceFootprint[countryId][provinceId].push(footprint);
      }
    }
  }

  setCountryId(countryId) {
    this.countryId = countryId;
  }

  parseProvince(footprint) {
    let countryId, provinceId;
    countryId = this.mapCountryName[footprint.country];
    if (countryId != null) {
      provinceId = this.mapProvinceName[countryId][footprint.province];
    }
    return {countryId, provinceId};
  }

  getMarkers() {
    return this.mapCountryFootprint[this.countryId].map(footprint => ({
      latLng: [footprint.lat, footprint.lng],
      name: footprint.footprint,
    }));
  }

  getProvinceColor() {
    let colors = {};
    let countryId = this.countryId;
    for (let provinceId in this.mapProvinceFootprint[countryId]) {
      colors[provinceId] = this.mapProvinceFootprint[countryId][provinceId].length > 0 ? 1 : 0;
    }
    return colors;
  }
}

class MapPlugin {
  constructor(options) {
    let {countryId, container, footprints} = options;
    assertCountryId(countryId);
    let config = MAP_CONFIG[countryId];
    let data = new FootprintData(footprints);
    data.setCountryId(countryId);
    let map = new jvm.Map({
      container: container,
      map: config.mapName,
      backgroundColor: '#B0C4DE',
      markers: data.getMarkers(),
    
      series: {
        regions: [{
          scale: ['#FFFFFF', '#FF9933'],
          attribute: 'fill',
          values: data.getProvinceColor(),
          min: 0,
          max: 1
        }]
      },
      markerStyle: {
        initial: {
          fill: '#33FF00',
          r: 4
        },
        selected: {
          fill: '#CA0020',
          r: 4
        }
      },
    
      onMarkerTipShow: function(event, label, index) {
        let footprint = data.mapCountryFootprint[countryId][index];
        let content = footprint.footprint;
        if (footprint.time !== '') {
          content += ' - ' + footprint.time;
        }
        if (footprint.description !== '') {
          content += '<br>' + footprint.description;
        }
        label.html(content);
      },
      onMarkerClick: function(event, code) {
        // window.location.href = 'gallery.html?code=' + code;
      },
      onMarkerOver: function(event, code) {
        let {provinceId} = data.parseProvince(data.mapCountryFootprint[countryId][code]);
        map.clearSelectedMarkers();
        if (provinceId != null) {
          map.setSelectedMarkers(data.mapProvinceFootprint[countryId][provinceId].map(footprint => footprint._index));
        } else {
          map.setSelectedMarkers(code);
        }
      },
    
      onRegionTipShow: function(event, label, code) {
        label.html(MAP_CONFIG[countryId].provinces[code].displayName);
      },
      onRegionClick: function(event, code) {
        // window.location.href = 'gallery.html?code=' + data.provinceName[code];
      },
      onRegionOver: function(event, code) {
        map.clearSelectedMarkers();
        map.setSelectedMarkers(data.mapProvinceFootprint[countryId][code].map(footprint => footprint._index));
      },
      onRegionOut: function(event, code) {
        map.clearSelectedMarkers();
      }
    });
    config.onload && config.onload(map);
  }
}

window.MapPlugin = MapPlugin;
